<!DOCTYPE html>
<html>
<head>
	<title>Saneema</title>
	<style type="text/css">
		* {
			padding: 0;
			margin: 0;
		}

		html, body {
			padding: 10px;
			height: 100%;
		}

		body {
			background: #222;
			color: #fff;
		}

		.content {
			display: flex;
			flex-direction: row;
		}

		form input, button  {
			padding: 5px;
		}

		.left, .right {
			/*border: 1px solid;*/
			height: 100%;
			width: 50%;
			flex: 1;
			flex-shrink: 0;
			word-wrap: : break-word;
			margin: 10px 5px 10px 0;
		}

		.right > h3 {
			display: inline-block;
		}

		.right > button {
			float: right;
		}

		.movie {
			padding: 10px;
			margin: 10px;
			display: flex;
			flex-direction: row;
		}

		.movie > * {
			margin: 10px;
		}

		.detail > * {
			line-height: 1;
			margin: 5px;
		}

		.detail > button {
			padding: 10px;
		}

		.movie img {
			width: 150px;
		}

	</style>
</head>
<body>
	<h1>Saneema</h1>
	<div id="content" class="content">
		<div class="left">
			<form>
				<input id="title" type="text" name="title" placeholder="Title">
				<input id="year" type="text" name="year" placeholder="Year">
				<button id="search" >Search</button>
			</form>
			<div id="result">
				<!-- Search result here -->
			</div>
			<img src="">
			<input id="add" type="submit" name="submit" value="Add" onclick="add()" style="display: none;">
			<label id="status"></label>
		</div>
		<div class="right">
			<h3>You have watched</h3>&nbsp;<span id="count"></span>
			<button id="refresh" onclick="refresh()">Refresh</button>
			<div id="list">
				
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
		let currentImdbID

		const title = document.querySelector('#title')
		const addBtn = document.querySelector('#add')
		const year = document.querySelector('#year')
		const result = document.querySelector('#result')
		const img = document.querySelector('img')
		const refreshBtn = document.querySelector('#refresh')
		const searchBtn = document.querySelector('#search')
		const count = document.querySelector('#count')


		const list = document.querySelector('#list')

		document.onload = refresh()

		function refresh() {
			fetch('/movies')
				.then((response) => {
					return response.json()
				})
				.then((jsonResponse) => {
					renderList(jsonResponse, list)
				})
				.catch((err) => {
					console.log(err)
				})
		}

		title.addEventListener('keyup', (event) => {
			//detect enter key up 
			if (event.keyCode === 13) {
				event.preventDefault()
				submit()
			}
		})

		searchBtn.addEventListener('click', (e) => {
			e.preventDefault()
			submit()
		})

		function submit() {

			let status = document.querySelector('#status')
			result.innerHTML = 'Searching...'
			if (title.value) {
				let url = '/search?title=' + title.value

				if (year.value) {
					url += '&year=' + year.value
				}

				fetch(url)
				.then((response) => {
					return response.json()
				})
				.then((jsonResponse) => {
					renderList(jsonResponse, result)
					
					// result.innerHTML = JSON.stringify(jsonResponse)
				})
				.catch((err) => {
					console.log(err)
					result.innerHTML = 'Movie not found'
				})
			}
			
		}

		function add(currentImdbID) {

			fetch('/add?imdbID=' + currentImdbID)
			.then((response) => {
				return response.json()
			})
			.then((response) => {
				if (response.success) {
					refresh()
				} else {
				}
			})
			.catch((err) => {
				status.innerHTML = 'Error'
				console.log(err)
			})
		}

		function remove(currentImdbID) {

			fetch('/movies/' + currentImdbID, {
				method: 'delete'
			})
			.then((response) => {
				return response.json()
			})
			.then((response) => {
				if (response.success) {
					refresh()
				} else {
				}
			})
			.catch((err) => {
				status.innerHTML = 'Error'
				console.log(err)
			})
		}

		function renderList(movies, parent) {
			parent.innerHTML = ''
			if (movies.data) {
				movies.data.forEach(movie => {
					let divElem = document.createElement('div')
					let detailElem = document.createElement('div')
					let titleElem = document.createElement('p')
					let yearElem = document.createElement('p')
					let typeElem = document.createElement('p')
					let imgElem = document.createElement('img')
					let btnElem = document.createElement('button')
					let btnDelElem = document.createElement('button')

					titleElem.innerHTML = 'Title - ' + movie.Title
					yearElem.innerHTML = 'Year - ' + movie.Year
					typeElem.innerHTML = 'Type - ' + movie.Type
					imgElem.setAttribute('src', movie.Poster)
					imgElem.setAttribute('alt', 'Image not found')
					btnElem.innerHTML = 'Add'
					btnDelElem.innerHTML = 'Delete'
					btnElem.addEventListener('click', (e) => {
						add(movie.imdbID)
					})
					btnDelElem.addEventListener('click', (e) => {
						remove(movie.imdbID)
					})
					detailElem.setAttribute('class', 'detail')
					detailElem.appendChild(titleElem)
					detailElem.appendChild(yearElem)
					detailElem.appendChild(typeElem)
					detailElem.appendChild(btnElem)

					if (movie._id) {
						count.innerHTML = '(' + movies.count + ')'
						detailElem.appendChild(btnDelElem)
					}

					divElem.setAttribute('class', 'movie')
					divElem.appendChild(imgElem)
					divElem.appendChild(detailElem)

					parent.appendChild(divElem)
				})
			} else {
				parent.innerHTML = 'No movie found'
			}
		}

 	</script>
</body>
</html>